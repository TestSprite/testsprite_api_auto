name: Nightly UI Test Suite

on:
  schedule:
    # 多个时间格式选择（北京时间 24:00）
    - cron: '0 16 * * *'      # UTC 16:00 = 北京时间 24:00

  workflow_dispatch:          # 手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  testsprite_ui_auto:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'  # 设置时区

    strategy:
      matrix:
        python-version: [3.8]
        shm-size: [2gb]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-html allure-pytest
        # 如果有特定的测试依赖
        pip install requests pycognito json
        # 增加系统资源
        sudo apt-get update
        sudo apt-get install -y libgbm-dev libnss3
        #安装jq工具
        sudo apt-get install -y jq

    - name: Install Allure Commandline
      run: |
        # 安装Allure命令行工具
        sudo apt-get update
        wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
        tar -zxvf allure-2.27.0.tgz
        sudo mv allure-2.27.0 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure
        allure --version

    - name: Run UI test cases
      run: |
        echo "开始运行API测试"
        python pytest_runcase_api.py
        echo "API测试结束"